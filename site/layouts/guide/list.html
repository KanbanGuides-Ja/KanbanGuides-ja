{{- define "main" }}
  {{/* Dynamically find the latest guide version in the current section */}}
  {{- $guidePage := "" }}
  {{- $latestVersion := "" }}

  {{/* Get all pages in the current section */}}
  {{- $sectionPages := where .Site.RegularPages "Section" .Section }}

  {{/* Filter for guide pages and sort by date (newest first) */}}
  {{- $guidePages := where $sectionPages "Type" "guide" }}
  {{- if $guidePages }}
    {{- $sortedPages := $guidePages.ByDate.Reverse }}
    {{- $guidePage = index $sortedPages 0 }}
  {{- end }}

  {{/* Fallback: try to find by version number in URL path */}}
  {{- if not $guidePage }}
    {{- range $sectionPages }}
      {{/* Extract version from URL path (e.g., /open-guide-for-kanban/2025.7/) */}}
      {{- $pathParts := split .RelPermalink "/" }}
      {{- range $pathParts }}
        {{- if and (ne . "") (findRE `^\d{4}\.\d+` .) }}
          {{- if or (not $latestVersion) (gt . $latestVersion) }}
            {{- $latestVersion = . }}
            {{- $guidePage = $ }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}

  {{/* Final fallback: get the section page itself */}}
  {{- if not $guidePage }}
    {{- $guidePage = .Site.GetPage .Section }}
  {{- end }}

  {{- if not $guidePage }}
    {{- $defaultSite := index site.Sites 0 }}
    {{- $guidePage = $defaultSite.GetPage .Section }}
  {{- end }}

  {{- if not $guidePage }}
    {{- fmt.Errorf "No guide page found for section: %s" .Section }}
  {{- end }}
  {{- $isComingSoon := and $guidePage $guidePage.Date (lt now $guidePage.Date) (eq hugo.Environment "production") }}
  {{- $bgColor := .Params.brand.bg_colour | default "#135289" }}
  
  {{ partial "components/guide-nav-menu.html" . }}
  
  <section class="section container-fluid main-header" style="background-color: {{ $bgColor }} !important;">
    <div class="container my-5">
      <div class="row">
        <div class="col-12 col-xl-4 p-3">
          <div class="card card-dark h-100">
            <div class="card-body text-center d-flex flex-column">
              <i class="header-icon fa-solid fa-newspaper"></i>
              <h5 class="card-title">{{ i18n "read_online_title" . }}</h5>
              <p class="card-text flex-grow-1">{{ i18n "read_online_description" . }}</p>
            </div>
            <div class="card-footer">
              {{- $latestVersion := partial "functions/get-latest-version" . }}
              <a href="{{ partial "functions/safe-page-link.html" (path.Join .Path $latestVersion) }}" class="btn btn-primary">{{ i18n "read_online_button" }}</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-4 p-3">
          <div class="card card-dark h-100">
            <div class="card-body text-center d-flex flex-column">
              <i class="header-icon fa-solid fa-download"></i>
              <h5 class="card-title">{{ i18n "translations_title" . }}</h5>
              <p class="card-text flex-grow-1">{{ i18n "translations_description" . }}</p>
            </div>
            <div class="card-footer">
              <a href="{{ partial "functions/safe-page-link.html" (path.Join .Path "translations") }}" class="btn btn-primary">{{ i18n "nav_translations" . }}</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-4 p-3">
          <div class="card card-dark h-100">
            <div class="card-body text-center d-flex flex-column">
              <i class="header-icon fa-solid fa-download"></i>
              <h5 class="card-title">{{ i18n "history_title" . }}</h5>
              <p class="card-text flex-grow-1">{{ i18n "history_description" . }}</p>
            </div>
            <div class="card-footer">
              <a href="{{ partial "functions/safe-page-link.html" (path.Join .Path "history") }}" class="btn btn-primary">{{ i18n "nav_history" . | default "History" }}</a>
            </div>
          </div>
        </div>
        <div class="col-12 p-3">
          <div class="card card-dark h-100">
            <div class="card-body text-center d-flex flex-column">
              <i class="header-icon fa-solid fa-comments"></i>
              <h5 class="card-title">{{ i18n "join_discussion_title" . }}</h5>
              <p class="card-text flex-grow-1">{{ i18n "join_discussion_description" . }}</p>
            </div>
            <div class="card-footer">
              {{ if $isComingSoon }}
                <a href="#" class="btn btn-primary disabled">coming soon</a>
              {{ else }}
                <a href="{{ .Site.Params.githubUrl }}/discussions" class="btn btn-primary" target="_blank">{{ i18n "join_discussion_button" }}</a>
              {{ end }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="section container-fluid">
    <div class="container my-5">
      <div class="row">
        <div class="col-12 col-lg-4 col-xl-6">
          <img src="{{ .Params.brand.image }}" class="img-fluid mb-3" alt="{{ .Title }}" />
        </div>
        <div class="col-12 col-lg-8 col-xl-6">
          <div>
            <div class="col-12">
              <h2 class="text-center">{{ i18n "what_is_guide_title" . }}</h2>
              <div class="lead text-center">
                {{- $guideWhatis := partial "functions/get-page-param-with-default.html" (dict "page" $guidePage "param" "guide_whatis" "context" .) }}
                {{- if $guideWhatis }}
                  {{ $guideWhatis | markdownify }}
                {{- else }}
                  {{ i18n "guide_content_not_found" | markdownify }}
                {{- end }}
              </div>
            </div>
            <div class="col-12 mt-4">
              <h2 class="text-center">{{ i18n "open_source_title" }}</h2>
              <p class="lead text-center">
                {{ i18n "open_source_description" . }}
              </p>
              {{ if $isComingSoon }}
                <a href="#" class="btn btn-primary disabled">{{ i18n "join_discussion_button" }}</a>
              {{ else }}
                <a href="{{ .Site.Params.githubUrl }}/discussions" class="btn btn-primary d-block mx-auto" target="_blank">{{ i18n "join_discussion_button" }}</a>
              {{ end }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{{- end }}
{{- define "template" }}
  guide/list.html
{{- end }}
